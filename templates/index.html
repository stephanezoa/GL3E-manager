{% extends "base.html" %}

{% block title %}GL3E - Demander un Projet{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-iai-blue via-blue-800 to-blue-900 py-3 sm:py-12 px-3 sm:px-6 lg:px-8 flex items-start sm:items-center justify-center relative overflow-x-hidden">
    <!-- Animated background elements -->
    <div class="absolute inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-1/4 left-1/4 w-64 h-64 bg-iai-gold opacity-5 rounded-full blur-3xl animate-float"></div>
        <div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-blue-300 opacity-5 rounded-full blur-3xl animate-float-delayed"></div>
    </div>

    <div class="w-full max-w-xl sm:max-w-lg relative z-10">
        <!-- Header -->
        <div class="text-center mb-4 sm:mb-10 animate-slide-down">
            <div class="inline-block bg-gradient-to-br from-white to-slate-100 p-2.5 sm:p-4 rounded-2xl shadow-2xl mb-3 sm:mb-6 transform hover:scale-105 transition-transform duration-300 ring-2 ring-white/70">
                <img src="/static/img/image.png" 
                     alt="IAI Logo"
                     class="h-14 w-14 sm:h-20 sm:w-20 object-contain animate-pulse-slow drop-shadow-md">
            </div>
            <h1 class="text-xl sm:text-3xl lg:text-4xl font-extrabold text-white mb-1.5 sm:mb-2 tracking-tight drop-shadow-lg">
                IAI-CAMEROUN
            </h1>
            <p class="text-iai-gold text-sm sm:text-lg font-semibold tracking-wide drop-shadow">
                Attribution de Projets GL3E
            </p>
        </div>

        <!-- Main Card -->
        <div class="glass-enhanced rounded-2xl sm:rounded-3xl shadow-2xl p-4 sm:p-8 lg:p-10 animate-slide-up relative overflow-hidden backdrop-blur-xl">
            <!-- Decorative gradient bar -->
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-iai-gold via-iai-blue to-iai-gold animate-shimmer"></div>
            
            <!-- Decorative corner elements -->
            <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-iai-gold/10 to-transparent rounded-bl-full"></div>
            <div class="absolute bottom-0 left-0 w-20 h-20 bg-gradient-to-tr from-iai-blue/10 to-transparent rounded-tr-full"></div>

            <!-- Frontend event/status panel -->
            <div id="eventPanel" class="hidden mb-4 sm:mb-5 rounded-xl border px-4 py-3 text-xs sm:text-sm shadow-sm"></div>

            <!-- Progress Steps -->
            <div class="mb-5 sm:mb-6">
                <div class="grid grid-cols-3 gap-2">
                    <div id="progressStep1" class="progress-step active">1. Identit√©</div>
                    <div id="progressStep2" class="progress-step">2. V√©rification</div>
                    <div id="progressStep3" class="progress-step">3. Attribution</div>
                </div>
            </div>

            <!-- Step 1: Student Selection -->
            <div id="step1" class="step-panel space-y-5 sm:space-y-6">
                <div class="text-center mb-4 sm:mb-6">
                    <div class="inline-flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 bg-gradient-to-br from-iai-blue to-blue-700 rounded-2xl mb-3 sm:mb-4 shadow-lg transform hover:rotate-12 transition-transform duration-300">
                        <svg class="w-6 h-6 sm:w-7 sm:h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <h2 class="text-xl sm:text-2xl font-bold text-iai-blue mb-1 sm:mb-2">Obtenir mon Th√®me</h2>
                    <p class="text-gray-500 text-xs sm:text-sm">Choisissez votre nom pour commencer</p>
                </div>

                <!-- Student Selection with Search -->
                <div class="space-y-3 sm:space-y-4 animate-fade-in">
                    <label class="block text-xs sm:text-sm font-semibold text-gray-700 flex items-center gap-2">
                        <svg class="w-4 h-4 text-iai-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        Votre identit√©
                    </label>
                    
                    <!-- Search Input -->
                    <div class="relative group">
                        <input type="text" 
                               id="studentSearch" 
                               placeholder="Rechercher votre nom..."
                               maxlength="120"
                               class="w-full px-4 py-3 sm:py-3.5 pl-11 border-2 border-gray-200 rounded-xl sm:rounded-2xl focus:ring-2 focus:ring-iai-blue focus:border-iai-blue bg-white transition-all duration-300 text-gray-800 text-sm sm:text-base shadow-sm hover:shadow-md group-hover:border-gray-300"
                               autocomplete="off">
                        <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-iai-blue transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                    </div>

                    <!-- Student Select -->
                    <div class="relative group">
                        <select id="studentSelect"
                                class="w-full pl-4 pr-10 py-3 sm:py-4 border-2 border-gray-200 rounded-xl sm:rounded-2xl focus:ring-2 focus:ring-iai-blue focus:border-iai-blue appearance-none bg-gradient-to-br from-gray-50 to-white transition-all duration-300 text-gray-800 font-medium text-sm sm:text-base shadow-sm hover:shadow-md cursor-pointer group-hover:border-gray-300">
                            <option value="" class="text-gray-400">-- S√©lectionnez votre nom --</option>
                            {% for s in students %}
                            <option value="{{ s.name }}">{{ s.name.title() }} ({{ s.matricule }})</option>
                            {% endfor %}
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 sm:px-4 text-iai-blue group-focus-within:scale-110 transition-transform">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" />
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Contact Method -->
                <div class="space-y-3 sm:space-y-4 animate-fade-in animation-delay-100">
                    <label class="block text-xs sm:text-sm font-semibold text-gray-700 flex items-center gap-2">
                        <svg class="w-4 h-4 text-iai-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        Recevoir le code par :
                    </label>
                    <div class="grid grid-cols-2 gap-3 sm:gap-4">
                        <label class="relative flex items-center justify-center p-3 sm:p-4 border-2 border-gray-200 rounded-xl sm:rounded-2xl cursor-pointer hover:border-iai-blue hover:shadow-lg transition-all duration-300 group has-[:checked]:border-iai-blue has-[:checked]:bg-gradient-to-br has-[:checked]:from-blue-50 has-[:checked]:to-blue-100 has-[:checked]:shadow-lg transform hover:scale-105 active:scale-95">
                            <input type="radio" name="contactMethod" value="email" class="sr-only" checked>
                            <div class="flex flex-col items-center gap-2">
                                <svg class="w-5 h-5 sm:w-6 sm:h-6 text-gray-400 group-has-[:checked]:text-iai-blue transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                                <span class="text-xs sm:text-sm font-bold text-gray-600 group-has-[:checked]:text-iai-blue transition-colors">Email</span>
                            </div>
                        </label>
                        <label class="relative flex items-center justify-center p-3 sm:p-4 border-2 border-gray-200 rounded-xl sm:rounded-2xl cursor-pointer hover:border-iai-blue hover:shadow-lg transition-all duration-300 group has-[:checked]:border-iai-blue has-[:checked]:bg-gradient-to-br has-[:checked]:from-blue-50 has-[:checked]:to-blue-100 has-[:checked]:shadow-lg transform hover:scale-105 active:scale-95">
                            <input type="radio" name="contactMethod" value="sms" class="sr-only">
                            <div class="flex flex-col items-center gap-2">
                                <svg class="w-5 h-5 sm:w-6 sm:h-6 text-gray-400 group-has-[:checked]:text-iai-blue transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                </svg>
                                <span class="text-xs sm:text-sm font-bold text-gray-600 group-has-[:checked]:text-iai-blue transition-colors text-center">SMS</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Contact Value -->
                <div class="space-y-2 sm:space-y-3 animate-fade-in animation-delay-200">
                    <label id="contactLabel" class="block text-xs sm:text-sm font-semibold text-gray-700 flex items-center gap-2">
                        <svg class="w-4 h-4 text-iai-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        Votre email
                    </label>
                    <div class="relative group">
                        <input type="text" 
                               id="contactValue" 
                               placeholder="nom.prenom@iai-cm.com"
                               maxlength="254"
                               class="w-full px-4 py-3 sm:py-4 border-2 border-gray-200 rounded-xl sm:rounded-2xl focus:ring-2 focus:ring-iai-blue focus:border-iai-blue bg-gradient-to-br from-gray-50 to-white transition-all duration-300 text-sm sm:text-base shadow-sm hover:shadow-md group-hover:border-gray-300"
                               autocomplete="email">
                    </div>
                    <p class="text-[10px] sm:text-xs text-gray-500 font-medium uppercase tracking-wider pl-1 flex items-center gap-2" id="contactHint">
                        <svg class="w-3 h-3 text-iai-blue" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                        INDISPENSABLE POUR LA V√âRIFICATION
                    </p>
                </div>

                <!-- Submit Button -->
                <button onclick="requestOTP()"
                        class="w-full bg-gradient-to-r from-iai-blue to-blue-700 text-white py-3.5 sm:py-4 rounded-xl sm:rounded-2xl font-bold text-base sm:text-lg shadow-xl shadow-blue-900/30 hover:shadow-2xl hover:shadow-blue-900/40 hover:from-blue-700 hover:to-iai-blue active:scale-[0.97] transition-all duration-300 flex items-center justify-center space-x-2 group relative overflow-hidden">
                    <span class="relative z-10">Me donner un th√®me</span>
                    <svg class="w-5 h-5 relative z-10 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                    </svg>
                    <div class="absolute inset-0 bg-gradient-to-r from-iai-gold/20 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
                </button>
            </div>

            <!-- Step 2: OTP Verification -->
            <div id="step2" class="step-panel hidden space-y-5 sm:space-y-6 animate-fade-in">
                <div class="text-center">
                    <div class="inline-flex items-center justify-center w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-br from-blue-100 to-blue-200 rounded-3xl mb-4 sm:mb-6 shadow-xl animate-bounce-slow">
                        <svg class="w-8 h-8 sm:w-10 sm:h-10 text-iai-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                    </div>
                    <h2 class="text-xl sm:text-2xl font-bold text-iai-blue mb-2 sm:mb-3">V√©rification</h2>
                    <p class="text-gray-500 text-xs sm:text-sm leading-relaxed px-2">
                        Un code secret a √©t√© envoy√© √† :<br>
                        <span id="sentTo" class="font-bold text-gray-800 text-sm sm:text-base inline-block mt-2 px-4 py-2 bg-blue-50 rounded-lg"></span>
                    </p>
                </div>

                <!-- OTP Input -->
                <div class="space-y-3 sm:space-y-4">
                    <div class="relative">
                        <input type="text" 
                               id="otpCode" 
                               maxlength="6" 
                               placeholder="000000"
                               inputmode="numeric"
                               pattern="[0-9]*"
                               class="w-full px-4 py-5 sm:py-6 border-2 border-iai-blue/30 rounded-2xl sm:rounded-3xl text-center text-3xl sm:text-4xl font-extrabold tracking-[0.3em] sm:tracking-[0.5em] focus:ring-4 focus:ring-iai-blue/20 focus:border-iai-blue bg-white transition-all text-iai-blue placeholder-gray-200 shadow-lg hover:shadow-xl"
                               autocomplete="one-time-code">
                        <div class="absolute inset-0 rounded-2xl sm:rounded-3xl bg-gradient-to-r from-iai-blue/5 to-blue-500/5 pointer-events-none"></div>
                    </div>
                    <div class="flex items-center justify-center gap-2">
                        <div class="w-2 h-2 bg-iai-blue rounded-full animate-pulse"></div>
                        <p class="text-center text-xs sm:text-sm text-iai-blue font-bold">Entrez les 6 chiffres re√ßus</p>
                        <div class="w-2 h-2 bg-iai-blue rounded-full animate-pulse animation-delay-300"></div>
                    </div>
                </div>

                <!-- Verify Button -->
                <button onclick="verifyOTP()"
                        class="w-full bg-gradient-to-r from-iai-green to-green-600 text-white py-3.5 sm:py-4 rounded-xl sm:rounded-2xl font-bold text-base sm:text-lg shadow-xl shadow-green-900/30 hover:shadow-2xl hover:shadow-green-900/40 hover:from-green-600 hover:to-iai-green active:scale-[0.97] transition-all duration-300 group relative overflow-hidden">
                    <span class="relative z-10">Confirmer & Proc√©der</span>
                    <div class="absolute inset-0 bg-gradient-to-r from-white/20 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
                </button>

                <!-- Back Button -->
                <button onclick="backToStep1()"
                        class="w-full text-gray-500 font-semibold text-xs sm:text-sm hover:text-iai-blue transition-colors py-2 flex items-center justify-center gap-2 group">
                    <svg class="w-4 h-4 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Modifier mes coordonn√©es
                </button>
            </div>

            <!-- Step 3: Success -->
            <div id="step3" class="step-panel hidden space-y-6 sm:space-y-8 py-4 animate-fade-in">
                <!-- Success Icon -->
                <div class="relative text-center animate-bounce-in">
                    <div class="text-6xl sm:text-7xl lg:text-8xl animate-bounce-slow">üéì</div>
                    <div class="absolute -top-2 sm:-top-4 -right-2 text-2xl sm:text-3xl animate-pulse">‚ú®</div>
                    <div class="absolute -bottom-2 -left-2 text-2xl sm:text-3xl animate-pulse animation-delay-300">üéâ</div>
                </div>

                <!-- Success Message -->
                <div class="text-center animate-slide-up">
                    <h2 class="text-2xl sm:text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-iai-green to-green-600 mb-2 sm:mb-3">
                        Th√®me Attribu√© !
                    </h2>
                    <p class="text-gray-500 text-sm sm:text-base">Fiche officielle d'attribution</p>
                </div>

                <div class="bg-blue-50 border border-blue-200 text-blue-900 rounded-xl px-4 py-3 text-xs sm:text-sm font-semibold">
                    Important: t√©l√©chargez maintenant votre th√®me en PDF (ou copiez les d√©tails). Cette attribution est unique.
                </div>

                <!-- Primary Actions (visible first) -->
                <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 animate-fade-in animation-delay-100">
                    <button onclick="exportThemePDF()"
                            class="w-full bg-gradient-to-r from-iai-blue to-blue-700 text-white py-3.5 sm:py-4 rounded-xl sm:rounded-2xl text-sm sm:text-base font-extrabold shadow-xl shadow-blue-900/25 hover:shadow-2xl hover:shadow-blue-900/35 hover:from-blue-700 hover:to-iai-blue transition-all duration-300 ring-2 ring-blue-200/70">
                        Exporter mon th√®me en PDF
                    </button>
                    <button onclick="copyThemeDetails()"
                            class="w-full bg-white text-iai-blue py-3.5 sm:py-4 rounded-xl sm:rounded-2xl text-sm sm:text-base font-extrabold border-2 border-iai-blue/40 shadow-md hover:shadow-lg hover:bg-blue-50 transition-all duration-300">
                        Copier mon th√®me et d√©tails
                    </button>
                </div>

                <!-- Assignment Card -->
                <div class="bg-gradient-to-br from-gray-50 to-white border-2 border-dashed border-gray-300 p-5 sm:p-6 lg:p-8 rounded-2xl sm:rounded-3xl relative shadow-lg hover:shadow-xl transition-all duration-300 animate-scale-in">
                    <div class="absolute -top-3 sm:-top-4 left-1/2 -translate-x-1/2 bg-gradient-to-r from-iai-blue to-blue-700 text-white text-[9px] sm:text-[10px] px-3 sm:px-4 py-1 sm:py-1.5 rounded-full font-bold uppercase tracking-widest shadow-lg">
                        Votre Attribution
                    </div>
                    
                    <div class="mt-2 sm:mt-3">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                            <div class="bg-white/70 rounded-xl p-3 border border-gray-200">
                                <p class="text-[10px] sm:text-xs font-semibold text-gray-500 uppercase tracking-wide">√âtudiant</p>
                                <p id="assignedStudentName" class="text-sm sm:text-base font-bold text-gray-800 mt-1 break-words"></p>
                            </div>
                            <div class="bg-white/70 rounded-xl p-3 border border-gray-200">
                                <p class="text-[10px] sm:text-xs font-semibold text-gray-500 uppercase tracking-wide">Matricule</p>
                                <p id="assignedStudentMatricule" class="text-sm sm:text-base font-bold text-gray-800 mt-1 break-all"></p>
                            </div>
                            <div class="bg-white/70 rounded-xl p-3 border border-gray-200 sm:col-span-2">
                                <p class="text-[10px] sm:text-xs font-semibold text-gray-500 uppercase tracking-wide">Date d'attribution</p>
                                <p id="assignedDate" class="text-sm sm:text-base font-bold text-gray-800 mt-1"></p>
                            </div>
                        </div>

                        <h3 id="projectTitle" class="text-lg sm:text-xl lg:text-2xl font-black text-iai-blue mb-3 sm:mb-4 leading-tight"></h3>
                        <div class="h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent w-full mb-3 sm:mb-4"></div>
                        <div class="bg-blue-50 rounded-xl p-3 sm:p-4">
                            <p id="projectDesc" class="text-gray-700 text-xs sm:text-sm leading-relaxed text-left"></p>
                        </div>
                    </div>
                </div>

                <!-- Warning Box -->
                <div class="bg-gradient-to-r from-amber-50 to-orange-50 border-l-4 border-iai-gold p-4 sm:p-5 rounded-xl sm:rounded-2xl text-gray-700 text-xs sm:text-sm font-medium leading-relaxed shadow-md animate-fade-in animation-delay-200">
                    <div class="flex gap-3 items-start">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-iai-gold flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        <p>Vous ne pourrez plus demander de nouveau th√®me. En cas de probl√®me, contactez la Direction.</p>
                    </div>
                </div>

                <!-- Close Button -->
                <button onclick="resetFlow()"
                        class="w-full text-iai-blue font-bold border-2 border-iai-blue hover:bg-iai-blue hover:text-white py-3 rounded-xl sm:rounded-2xl text-sm sm:text-base transition-all duration-300 flex items-center justify-center gap-2 group shadow-md hover:shadow-lg">
                    <svg class="w-5 h-5 group-hover:rotate-90 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    Terminer et fermer
                </button>
            </div>
        </div>

        <!-- Public Link -->
        <div class="text-center mt-6 sm:mt-10 animate-fade-in animation-delay-300">
            <a href="/projets-attribues"
               class="inline-flex items-center text-white/90 hover:text-iai-gold transition-all duration-300 text-xs sm:text-sm font-semibold group px-4 py-2 rounded-xl hover:bg-white/10 backdrop-blur-sm">
                <svg class="w-4 h-4 mr-2 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                <span>Consulter la liste officielle</span>
                <svg class="w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </a>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
    <div class="bg-white rounded-3xl p-8 shadow-2xl text-center max-w-sm mx-4 animate-scale-in">
        <div class="w-16 h-16 border-4 border-iai-blue border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
        <p class="text-gray-700 font-semibold">Traitement en cours...</p>
    </div>
</div>

<!-- Center Popup Notification -->
<div id="toast" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4 pointer-events-none">
    <div id="toastContent" class="rounded-2xl shadow-2xl p-4 sm:p-4 flex items-start gap-3 backdrop-blur-xl border max-w-md w-full pointer-events-auto">
        <svg id="toastIcon" class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"></svg>
        <div class="flex-1 min-w-0">
            <p id="toastTitle" class="font-extrabold text-xs uppercase tracking-wide"></p>
            <p id="toastMessage" class="font-semibold text-sm sm:text-[15px] leading-5 break-words mt-0.5"></p>
            <div class="w-full h-1 rounded-full bg-white/25 mt-2 overflow-hidden">
                <div id="toastProgress" class="h-full bg-white/90 w-full"></div>
            </div>
        </div>
        <button id="toastClose" type="button" class="text-white/90 hover:text-white text-lg leading-none font-bold px-1" aria-label="Fermer la notification">√ó</button>
    </div>
</div>

<style>
    html {
        scroll-behavior: smooth;
    }

    /* Enhanced Glass Effect */
    .glass-enhanced {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .step-panel {
        transition: opacity 220ms ease, transform 220ms ease;
    }

    #eventPanel {
        line-height: 1.4;
    }

    #toastProgress {
        transform-origin: left center;
    }

    #toast {
        background: rgba(2, 6, 23, 0.24);
        backdrop-filter: blur(3px);
    }

    #toastContent {
        transform: translateY(8px) scale(0.97);
        opacity: 0;
        transition: transform 180ms ease, opacity 180ms ease;
    }

    #toast.toast-visible #toastContent {
        transform: translateY(0) scale(1);
        opacity: 1;
    }

    .progress-step {
        text-align: center;
        font-size: 11px;
        font-weight: 700;
        color: #64748b;
        border: 1px solid #dbe2ea;
        background: #f8fafc;
        border-radius: 9999px;
        padding: 0.4rem 0.5rem;
        transition: all 200ms ease;
    }

    .progress-step.active {
        color: #1e3a8a;
        border-color: #93c5fd;
        background: #eff6ff;
        box-shadow: 0 4px 10px rgba(30, 58, 138, 0.12);
    }

    /* Animations */
    @keyframes float {
        0%, 100% { transform: translateY(0) rotate(0deg); }
        33% { transform: translateY(-20px) rotate(5deg); }
        66% { transform: translateY(10px) rotate(-5deg); }
    }

    @keyframes shimmer {
        0% { background-position: -1000px 0; }
        100% { background-position: 1000px 0; }
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    @keyframes scaleIn {
        from {
            opacity: 0;
            transform: scale(0.9);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    @keyframes bounceIn {
        0% {
            opacity: 0;
            transform: scale(0.3);
        }
        50% {
            opacity: 1;
            transform: scale(1.05);
        }
        70% {
            transform: scale(0.9);
        }
        100% {
            transform: scale(1);
        }
    }

    @keyframes bounceSlow {
        0%, 100% {
            transform: translateY(0);
        }
        50% {
            transform: translateY(-10px);
        }
    }

    @keyframes pulseSlow {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.6;
        }
    }

    .animate-float {
        animation: float 20s ease-in-out infinite;
    }

    .animate-float-delayed {
        animation: float 20s ease-in-out infinite;
        animation-delay: -10s;
    }

    .animate-shimmer {
        background-size: 1000px 100%;
        animation: shimmer 3s linear infinite;
    }

    .animate-slide-down {
        animation: slideDown 0.6s ease-out;
    }

    .animate-slide-up {
        animation: slideUp 0.6s ease-out;
    }

    .animate-fade-in {
        animation: fadeIn 0.6s ease-out;
    }

    .animate-scale-in {
        animation: scaleIn 0.6s ease-out;
    }

    .animate-bounce-in {
        animation: bounceIn 0.8s ease-out;
    }

    .animate-bounce-slow {
        animation: bounceSlow 2s ease-in-out infinite;
    }

    .animate-pulse-slow {
        animation: pulseSlow 3s ease-in-out infinite;
    }

    .animation-delay-100 {
        animation-delay: 0.1s;
    }

    .animation-delay-200 {
        animation-delay: 0.2s;
    }

    .animation-delay-300 {
        animation-delay: 0.3s;
    }

    /* Input focus states */
    input:focus, select:focus {
        outline: none;
    }

    /* Custom scrollbar */
    select::-webkit-scrollbar {
        width: 8px;
    }

    select::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    select::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }

    select::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    /* Responsive text sizing */
    @media (max-width: 640px) {
        .animate-float,
        .animate-float-delayed {
            display: none !important;
        }

        .glass-enhanced {
            border-radius: 1rem;
            padding: 1rem !important;
        }

        .hover\:scale-105:hover,
        .group:hover .group-hover\:translate-x-1 {
            transform: none !important;
        }

        #toastContent {
            border-radius: 0.95rem;
            box-shadow: 0 14px 35px rgba(15, 23, 42, 0.22);
            border-color: rgba(255, 255, 255, 0.2);
            max-width: min(92vw, 420px);
        }

        #toastIcon {
            width: 1.15rem;
            height: 1.15rem;
            margin-top: 0.1rem;
        }

        .tracking-\[0\.5em\] {
            letter-spacing: 0.3em;
        }

        #step3 button {
            min-height: 48px;
        }

        #step1 button, #step2 button {
            min-height: 48px;
        }
    }

    /* Extra compact devices (320px-360px) */
    @media (max-width: 360px) {
        #step1, #step2, #step3 {
            gap: 1rem !important;
        }

        #studentSearch, #studentSelect, #contactValue {
            font-size: 0.8125rem;
            padding-top: 0.65rem;
            padding-bottom: 0.65rem;
        }

        #otpCode {
            font-size: 1.6rem;
            letter-spacing: 0.22em;
            padding-top: 0.9rem;
            padding-bottom: 0.9rem;
        }

        #projectTitle {
            font-size: 1rem;
            line-height: 1.3;
        }

        #projectDesc {
            font-size: 0.75rem;
            line-height: 1.35;
        }

        #step3 .grid {
            gap: 0.6rem !important;
        }

        .progress-step {
            font-size: 10px;
            padding: 0.35rem 0.2rem;
        }

        #eventPanel {
            padding: 0.6rem 0.7rem;
            font-size: 0.7rem;
        }
    }
</style>

<script>
    let otpId = null;
    let verifiedOtpCode = null;
    let assignmentData = null;
    let allStudents = {{ students | tojson }};
    const STUDENT_FLOW_STORAGE_KEY = "gl3e_student_flow_state_v1";
    const STUDENT_FLOW_MAX_AGE_MS = 2 * 60 * 60 * 1000; // 2h
    let toastHideTimer = null;
    let toastProgressTimer = null;

    // Utility Functions
    function formatStudentName(name) {
        return (name || '')
            .toLowerCase()
            .replace(/\b([a-z√†√¢√ß√©√®√™√´√Æ√Ø√¥√ª√π√º√ø√±√¶≈ì])/g, (match) => match.toUpperCase());
    }

    function isDangerousInput(value) {
        return /[<>{}\\;$`]/.test(value || '');
    }

    function normalizeStudentNameInput(value) {
        return (value || '').replace(/\s+/g, ' ').trim();
    }

    function normalizeContactInput(value, contactMethod) {
        const input = (value || '').trim();
        if (contactMethod === 'email') {
            return input.toLowerCase();
        }
        return input.replace(/[^\d+]/g, '');
    }

    function showLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.classList.remove('hidden');
        }
    }

    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.classList.add('hidden');
        }
    }

    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        const toastContent = document.getElementById('toastContent');
        const toastIcon = document.getElementById('toastIcon');
        const toastTitle = document.getElementById('toastTitle');
        const toastMessage = document.getElementById('toastMessage');
        const toastProgress = document.getElementById('toastProgress');
        const toastClose = document.getElementById('toastClose');

        if (!toast || !toastContent || !toastIcon || !toastMessage || !toastTitle || !toastProgress || !toastClose) return;

        // Set colors and icons based on type
        const configs = {
            success: {
                title: 'Succ√®s',
                bg: 'bg-gradient-to-r from-green-500 to-green-600 text-white border-white/20',
                icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />'
            },
            error: {
                title: 'Erreur',
                bg: 'bg-gradient-to-r from-red-500 to-red-600 text-white border-white/20',
                icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />'
            },
            info: {
                title: 'Information',
                bg: 'bg-gradient-to-r from-blue-500 to-blue-600 text-white border-white/20',
                icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />'
            },
            warning: {
                title: 'Attention',
                bg: 'bg-gradient-to-r from-amber-500 to-orange-500 text-white border-white/20',
                icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M10.29 3.86l-7.4 12.8A1 1 0 003.76 18h16.48a1 1 0 00.87-1.34l-7.4-12.8a1 1 0 00-1.74 0z" />'
            }
        };

        const config = configs[type] || configs.info;
        if (toastHideTimer) clearTimeout(toastHideTimer);
        if (toastProgressTimer) clearTimeout(toastProgressTimer);

        toastContent.className = `rounded-2xl shadow-2xl p-4 flex items-start gap-3 backdrop-blur-xl ${config.bg}`;
        toastIcon.innerHTML = config.icon;
        toastTitle.textContent = config.title;
        toastMessage.textContent = message;
        toast.setAttribute('role', type === 'error' ? 'alert' : 'status');
        toast.setAttribute('aria-live', type === 'error' ? 'assertive' : 'polite');

        toast.classList.remove('hidden');
        requestAnimationFrame(() => {
            toast.classList.add('toast-visible');
        });
        toastProgress.style.transition = 'none';
        toastProgress.style.transform = 'scaleX(1)';

        const dismiss = () => {
            toast.classList.remove('toast-visible');
            setTimeout(() => toast.classList.add('hidden'), 160);
            if (toastHideTimer) clearTimeout(toastHideTimer);
            if (toastProgressTimer) clearTimeout(toastProgressTimer);
        };
        toastClose.onclick = dismiss;

        // Brief popup display, then auto-close
        const hideDelay = window.innerWidth <= 640 ? 3200 : 2600;
        toastProgressTimer = setTimeout(() => {
            toastProgress.style.transition = `transform ${hideDelay}ms linear`;
            toastProgress.style.transform = 'scaleX(0)';
        }, 20);

        toastHideTimer = setTimeout(dismiss, hideDelay);
    }

    function setEvent(message, type = 'info') {
        const panel = document.getElementById('eventPanel');
        if (!panel) return;

        const styles = {
            success: 'bg-green-50 border-green-200 text-green-800',
            error: 'bg-red-50 border-red-200 text-red-800',
            info: 'bg-blue-50 border-blue-200 text-blue-800',
            warning: 'bg-amber-50 border-amber-200 text-amber-800'
        };
        panel.className = `mb-4 sm:mb-5 rounded-xl border px-4 py-3 text-xs sm:text-sm shadow-sm ${styles[type] || styles.info}`;
        panel.textContent = message;
        panel.classList.remove('hidden');
    }

    function updateStepProgress(currentStep) {
        const steps = [1, 2, 3];
        for (const step of steps) {
            const el = document.getElementById(`progressStep${step}`);
            if (!el) continue;
            if (step === currentStep) {
                el.classList.add('active');
            } else {
                el.classList.remove('active');
            }
        }
    }

    function showStep(stepNumber) {
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        if (!step1 || !step2 || !step3) return;

        step1.classList.toggle('hidden', stepNumber !== 1);
        step2.classList.toggle('hidden', stepNumber !== 2);
        step3.classList.toggle('hidden', stepNumber !== 3);
        updateStepProgress(stepNumber);
    }

    function getCurrentStepNumber() {
        if (!document.getElementById('step3')?.classList.contains('hidden')) return 3;
        if (!document.getElementById('step2')?.classList.contains('hidden')) return 2;
        return 1;
    }

    function persistFlowState() {
        try {
            const studentSelect = document.getElementById('studentSelect');
            const contactValueInput = document.getElementById('contactValue');
            const otpInput = document.getElementById('otpCode');
            const sentToEl = document.getElementById('sentTo');
            const assignedStudentName = document.getElementById('assignedStudentName');
            const assignedStudentMatricule = document.getElementById('assignedStudentMatricule');
            const assignedDate = document.getElementById('assignedDate');
            const projectTitle = document.getElementById('projectTitle');
            const projectDesc = document.getElementById('projectDesc');
            const contactMethod = document.querySelector('input[name=\"contactMethod\"]:checked')?.value || 'email';

            const state = {
                savedAt: Date.now(),
                step: getCurrentStepNumber(),
                otpId,
                verifiedOtpCode,
                assignmentData,
                studentName: studentSelect?.value || '',
                contactMethod,
                contactValue: contactValueInput?.value || '',
                sentTo: sentToEl?.textContent || '',
                otpCodeDraft: otpInput?.value || '',
                assignedStudentName: assignedStudentName?.textContent || '',
                assignedStudentMatricule: assignedStudentMatricule?.textContent || '',
                assignedDate: assignedDate?.textContent || '',
                projectTitle: projectTitle?.textContent || '',
                projectDesc: projectDesc?.textContent || '',
            };

            localStorage.setItem(STUDENT_FLOW_STORAGE_KEY, JSON.stringify(state));
        } catch (_) {}
    }

    function clearFlowState() {
        try {
            localStorage.removeItem(STUDENT_FLOW_STORAGE_KEY);
        } catch (_) {}
    }

    function restoreFlowState() {
        try {
            const raw = localStorage.getItem(STUDENT_FLOW_STORAGE_KEY);
            if (!raw) return;
            const state = JSON.parse(raw);
            if (!state || !state.savedAt) return;
            if ((Date.now() - Number(state.savedAt)) > STUDENT_FLOW_MAX_AGE_MS) {
                clearFlowState();
                return;
            }

            otpId = state.otpId || null;
            verifiedOtpCode = state.verifiedOtpCode || null;
            assignmentData = state.assignmentData || null;

            const studentSelect = document.getElementById('studentSelect');
            const studentSearch = document.getElementById('studentSearch');
            const contactValueInput = document.getElementById('contactValue');
            const otpInput = document.getElementById('otpCode');
            const sentToEl = document.getElementById('sentTo');

            if (studentSelect && state.studentName) {
                studentSelect.value = state.studentName;
            }
            if (studentSearch && state.studentName) {
                studentSearch.value = state.studentName;
            }

            if (state.contactMethod) {
                const methodRadio = document.querySelector(`input[name=\"contactMethod\"][value=\"${state.contactMethod}\"]`);
                if (methodRadio) {
                    methodRadio.checked = true;
                    methodRadio.dispatchEvent(new Event('change'));
                }
            }

            if (contactValueInput && state.contactValue) {
                contactValueInput.value = state.contactValue;
            }
            if (otpInput && state.otpCodeDraft) {
                otpInput.value = state.otpCodeDraft;
            }
            if (sentToEl && state.sentTo) {
                sentToEl.textContent = state.sentTo;
            }

            if (state.step === 3) {
                const assignedStudentName = document.getElementById('assignedStudentName');
                const assignedStudentMatricule = document.getElementById('assignedStudentMatricule');
                const assignedDate = document.getElementById('assignedDate');
                const projectTitle = document.getElementById('projectTitle');
                const projectDesc = document.getElementById('projectDesc');
                if (assignedStudentName) assignedStudentName.textContent = state.assignedStudentName || '';
                if (assignedStudentMatricule) assignedStudentMatricule.textContent = state.assignedStudentMatricule || '';
                if (assignedDate) assignedDate.textContent = state.assignedDate || '';
                if (projectTitle) projectTitle.textContent = state.projectTitle || '';
                if (projectDesc) projectDesc.textContent = state.projectDesc || '';
            }

            showStep(state.step === 2 || state.step === 3 ? state.step : 1);
            if (state.step === 2) {
                setEvent("Session restaur√©e: saisissez votre OTP pour continuer.", "info");
            } else if (state.step === 3) {
                setEvent("Session restaur√©e: pensez √† t√©l√©charger votre th√®me maintenant.", "warning");
            }
        } catch (_) {}
    }

    function resetFlow() {
        clearFlowState();
        window.location.reload();
    }

    function parseApiError(response, data, fallbackMessage) {
        const detail = (data && data.detail) ? String(data.detail) : '';
        if (response.status === 429) {
            return detail || "Limite de demandes atteinte. Contactez l'administration.";
        }
        if (response.status === 400 && detail.toLowerCase().includes('code')) {
            return detail;
        }
        if (response.status === 500) {
            return detail || "Erreur serveur temporaire. R√©essayez dans quelques instants.";
        }
        return detail || fallbackMessage;
    }

    function renderStudentOptions(students, searchTerm = '') {
        const select = document.getElementById('studentSelect');
        if (!select) {
            console.error('Student select element not found');
            return;
        }

        const query = (searchTerm || '').trim().toLowerCase();
        const filtered = students.filter((s) => {
            if (!query) return true;
            const haystack = `${s.name} ${s.matricule}`.toLowerCase();
            return haystack.includes(query);
        });

        select.innerHTML = '<option value="">-- S√©lectionnez votre nom --</option>';
        
        filtered.forEach((s) => {
            const option = document.createElement('option');
            option.value = s.name;
            option.textContent = `${formatStudentName(s.name)} (${s.matricule})`;
            select.appendChild(option);
        });

        if (filtered.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'Aucun r√©sultat trouv√©';
            option.disabled = true;
            select.appendChild(option);
        }
    }

    // Load students on page load
    window.addEventListener('DOMContentLoaded', async () => {
        showStep(1);
        setEvent("S√©lectionnez votre nom puis choisissez email ou SMS pour recevoir le code OTP.", "info");
        try {
            const response = await fetch('/api/students');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const rawBody = await response.text();
            let payload = null;
            
            try {
                payload = rawBody ? JSON.parse(rawBody) : null;
            } catch (err) {
                console.error('JSON parse error:', err);
                payload = null;
            }

            const students = Array.isArray(payload)
                ? payload
                : (payload && Array.isArray(payload.students) ? payload.students : null);

            if (!students) {
                throw new Error('Format de r√©ponse invalide pour la liste des √©tudiants');
            }

            allStudents = students;
            renderStudentOptions(allStudents);
            restoreFlowState();
            if (getCurrentStepNumber() === 1) {
                setEvent("Liste des √©tudiants charg√©e. Vous pouvez d√©marrer la demande.", "success");
            }
        } catch (error) {
            console.error('Student loading failed:', error);
            renderStudentOptions(allStudents);
            restoreFlowState();
            showToast('Erreur de chargement des √©tudiants', 'error');
            if (getCurrentStepNumber() === 1) {
                setEvent("Erreur de chargement de la liste. V√©rifiez la connexion puis rechargez la page.", "error");
            }
        }
    });

    // Student search functionality
    const studentSearch = document.getElementById('studentSearch');
    if (studentSearch) {
        studentSearch.addEventListener('input', (e) => {
            e.target.value = normalizeStudentNameInput(e.target.value).replace(/[^A-Za-z√Ä-√ñ√ò-√∂√∏-√ø' -]/g, '');
            renderStudentOptions(allStudents, e.target.value);
            persistFlowState();
        });
        studentSearch.addEventListener('paste', (e) => {
            e.preventDefault();
            const pastedText = (e.clipboardData || window.clipboardData).getData('text') || '';
            const cleaned = normalizeStudentNameInput(pastedText).replace(/[^A-Za-z√Ä-√ñ√ò-√∂√∏-√ø' -]/g, '');
            e.target.value = cleaned;
            renderStudentOptions(allStudents, cleaned);
            persistFlowState();
        });
    }

    // Contact method change handler
    document.querySelectorAll('input[name="contactMethod"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            const label = document.getElementById('contactLabel');
            const input = document.getElementById('contactValue');
            const hint = document.getElementById('contactHint');

            if (!label || !input || !hint) return;

            if (e.target.value === 'email') {
                label.innerHTML = `
                    <svg class="w-4 h-4 text-iai-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    Votre email
                `;
                input.type = 'email';
                input.placeholder = 'exemple@email.com';
                input.maxLength = 254;
                input.autocomplete = 'email';
                hint.innerHTML = `
                    <svg class="w-3 h-3 text-iai-blue" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                    Vous recevrez un code de v√©rification par email
                `;
            } else {
                label.innerHTML = `
                    <svg class="w-4 h-4 text-iai-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
                    </svg>
                    Votre num√©ro de t√©l√©phone
                `;
                input.type = 'tel';
                input.placeholder = '6XX XX XX XX';
                input.maxLength = 16;
                input.autocomplete = 'tel';
                hint.innerHTML = `
                    <svg class="w-3 h-3 text-iai-blue" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                    Format camerounais uniquement (6XX XX XX XX)
                `;
            }
            persistFlowState();
        });
    });

    // OTP input auto-formatting
    const otpInput = document.getElementById('otpCode');
    if (otpInput) {
        otpInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 6);
            persistFlowState();
        });

        otpInput.addEventListener('paste', (e) => {
            e.preventDefault();
            const pastedText = (e.clipboardData || window.clipboardData).getData('text');
            const cleaned = pastedText.replace(/[^0-9]/g, '').slice(0, 6);
            e.target.value = cleaned;
            persistFlowState();
        });
    }

    document.getElementById('studentSelect')?.addEventListener('change', persistFlowState);
    document.getElementById('contactValue')?.addEventListener('input', (e) => {
        const method = document.querySelector('input[name="contactMethod"]:checked')?.value || 'email';
        let value = e.target.value || '';
        if (method === 'email') {
            value = value.replace(/[<>{}\\;$`]/g, '');
        } else {
            value = value.replace(/[^\d+\s]/g, '');
        }
        e.target.value = value;
        persistFlowState();
    });
    document.getElementById('contactValue')?.addEventListener('paste', (e) => {
        e.preventDefault();
        const method = document.querySelector('input[name="contactMethod"]:checked')?.value || 'email';
        const pastedText = (e.clipboardData || window.clipboardData).getData('text') || '';
        let cleaned = pastedText;
        if (method === 'email') {
            cleaned = pastedText.toLowerCase().replace(/[<>{}\\;$`\s]/g, '');
        } else {
            cleaned = pastedText.replace(/[^\d+\s]/g, '');
        }
        e.target.value = cleaned;
        persistFlowState();
    });

    // API Functions
    async function requestOTP() {
        const studentNameRaw = document.getElementById('studentSelect')?.value;
        const contactMethod = document.querySelector('input[name="contactMethod"]:checked')?.value;
        const contactValueRaw = document.getElementById('contactValue')?.value;
        const studentName = normalizeStudentNameInput(studentNameRaw);
        const contactValue = normalizeContactInput(contactValueRaw, contactMethod);

        // Validation
        if (!studentName) {
            showToast('Veuillez s√©lectionner votre nom', 'error');
            return;
        }

        if (!/^[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø' -]{2,120}$/.test(studentName)) {
            showToast('Nom √©tudiant invalide', 'error');
            return;
        }

        if (!contactValue || !contactValue.trim()) {
            showToast('Veuillez entrer votre ' + (contactMethod === 'email' ? 'email' : 'num√©ro'), 'error');
            return;
        }

        if (contactMethod !== 'email' && contactMethod !== 'sms') {
            showToast("M√©thode de contact invalide", 'error');
            return;
        }

        if (isDangerousInput(contactValue) || isDangerousInput(studentName)) {
            showToast("Entr√©e invalide d√©tect√©e", 'error');
            return;
        }

        // Email validation
        if (contactMethod === 'email') {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(contactValue) || contactValue.length > 254) {
                showToast('Veuillez entrer un email valide', 'error');
                return;
            }
        }

        // Phone validation for Cameroon
        if (contactMethod === 'sms') {
            const phoneRegex = /^6[0-9]{8}$/;
            const cleanedPhone = contactValue.replace(/[^\d]/g, '');
            if (!phoneRegex.test(cleanedPhone)) {
                showToast('Num√©ro invalide. Format: 6XX XX XX XX', 'error');
                return;
            }
        }

        showLoading();
        setEvent("Envoi du code OTP en cours...", "info");

        try {
            const response = await fetch('/api/request-project', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    student_name: studentName,
                    contact_type: contactMethod,
                    contact_value: contactValue.trim()
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(parseApiError(response, data, 'Erreur lors de la demande'));
            }

            otpId = data.otp_id;
            verifiedOtpCode = null;
            assignmentData = null;
            document.getElementById('sentTo').textContent = contactValue;
            
            // Transition to step 2
            showStep(2);
            
            // Focus on OTP input
            setTimeout(() => {
                document.getElementById('otpCode')?.focus();
            }, 300);

            showToast(data.message || 'Code envoy√© avec succ√®s', 'success');
            setEvent("Code OTP envoy√©. V√©rifiez votre messagerie et saisissez le code re√ßu.", "success");
            persistFlowState();

        } catch (error) {
            showToast(error.message, 'error');
            setEvent(error.message || "√âchec de l'envoi OTP", "error");
        } finally {
            hideLoading();
        }
    }

    async function verifyOTP() {
        const code = document.getElementById('otpCode')?.value;

        if (!code || code.length !== 6) {
            showToast('Veuillez entrer le code √† 6 chiffres', 'error');
            return;
        }

        if (!otpId) {
            showToast('Session expir√©e. Veuillez recommencer', 'error');
            backToStep1();
            return;
        }

        showLoading();
        setEvent("V√©rification du code OTP...", "info");

        try {
            const response = await fetch('/api/verify-otp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    otp_id: otpId,
                    code: code
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(parseApiError(response, data, 'Code incorrect'));
            }

            // Update project information
            const projectTitle = document.getElementById('projectTitle');
            const projectDesc = document.getElementById('projectDesc');
            
            if (projectTitle && data.project?.title) {
                projectTitle.textContent = data.project.title;
            }
            
            if (projectDesc && data.project?.description) {
                projectDesc.textContent = data.project.description;
            }

            verifiedOtpCode = code;
            assignmentData = data.assignment || null;

            const assignedStudentName = document.getElementById('assignedStudentName');
            const assignedStudentMatricule = document.getElementById('assignedStudentMatricule');
            const assignedDate = document.getElementById('assignedDate');

            if (assignedStudentName) {
                assignedStudentName.textContent = data.student?.name || '';
            }
            if (assignedStudentMatricule) {
                assignedStudentMatricule.textContent = data.student?.matricule || '';
            }
            if (assignedDate) {
                if (assignmentData?.assigned_at) {
                    assignedDate.textContent = new Date(assignmentData.assigned_at).toLocaleString('fr-FR');
                } else {
                    assignedDate.textContent = new Date().toLocaleString('fr-FR');
                }
            }

            // Transition to step 3
            showStep(3);

            showToast('Th√®me attribu√© avec succ√®s !', 'success');
            if (data.project_pdf_email_sent) {
                setEvent("Th√®me attribu√©. Le PDF a aussi √©t√© envoy√© par email.", "success");
            } else if (data.project_pdf_email_error) {
                setEvent("Th√®me attribu√©. L'envoi email du PDF a √©chou√©, utilisez le bouton d'export.", "warning");
            } else {
                setEvent("Th√®me attribu√© avec succ√®s. Vous pouvez l'exporter en PDF ou le copier.", "success");
            }
            persistFlowState();

        } catch (error) {
            showToast(error.message, 'error');
            setEvent(error.message || "√âchec de la v√©rification OTP", "error");
            // Clear OTP input on error
            const otpInput = document.getElementById('otpCode');
            if (otpInput) {
                otpInput.value = '';
                otpInput.focus();
            }
        } finally {
            hideLoading();
        }
    }

    function backToStep1() {
        showStep(1);
        
        const otpInput = document.getElementById('otpCode');
        if (otpInput) {
            otpInput.value = '';
        }
        
        otpId = null;
        verifiedOtpCode = null;
        assignmentData = null;
        setEvent("Informations modifi√©es. Demandez un nouveau code OTP.", "info");
        persistFlowState();
    }

    async function exportThemePDF() {
        if (!otpId || !verifiedOtpCode) {
            showToast("Export impossible: v√©rifiez votre OTP d'abord", 'error');
            setEvent("Export bloqu√©: v√©rification OTP requise.", "error");
            return;
        }

        showLoading();
        setEvent("G√©n√©ration du PDF en cours...", "info");
        try {
            const response = await fetch('/api/export-my-theme-pdf', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    otp_id: otpId,
                    code: verifiedOtpCode
                })
            });

            if (!response.ok) {
                let detail = "Erreur lors de l'export PDF";
                try {
                    const data = await response.json();
                    detail = data.detail || detail;
                } catch (_) {}
                throw new Error(detail);
            }

            const blob = await response.blob();
            const objectUrl = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = objectUrl;
            a.download = 'mon_theme_gl3e.pdf';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(objectUrl);
            showToast('PDF t√©l√©charg√© avec succ√®s', 'success');
            setEvent("PDF t√©l√©charg√© avec succ√®s.", "success");
            persistFlowState();
        } catch (error) {
            showToast(error.message || "Erreur d'export PDF", 'error');
            setEvent(error.message || "Erreur d'export PDF", "error");
        } finally {
            hideLoading();
        }
    }

    async function copyThemeDetails() {
        const studentName = document.getElementById('assignedStudentName')?.textContent?.trim() || '';
        const matricule = document.getElementById('assignedStudentMatricule')?.textContent?.trim() || '';
        const assignedDate = document.getElementById('assignedDate')?.textContent?.trim() || new Date().toLocaleString('fr-FR');
        const title = document.getElementById('projectTitle')?.textContent?.trim() || '';
        const description = document.getElementById('projectDesc')?.textContent?.trim() || '';

        if (!title) {
            showToast("Aucun th√®me √† copier pour l'instant", 'error');
            setEvent("Copie impossible: aucun th√®me affich√©.", "error");
            return;
        }

        const textToCopy = [
            "Attribution de Projet GL3E",
            `√âtudiant: ${studentName}`,
            `Matricule: ${matricule}`,
            `Date d'attribution: ${assignedDate}`,
            `Th√®me: ${title}`,
            `Description: ${description}`,
        ].join('\n');

        try {
            if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(textToCopy);
            } else {
                const temp = document.createElement('textarea');
                temp.value = textToCopy;
                temp.style.position = 'fixed';
                temp.style.left = '-9999px';
                document.body.appendChild(temp);
                temp.focus();
                temp.select();
                document.execCommand('copy');
                temp.remove();
            }
            showToast('Th√®me et d√©tails copi√©s', 'success');
            setEvent("Les d√©tails de votre th√®me ont √©t√© copi√©s.", "success");
            persistFlowState();
        } catch (error) {
            showToast('Copie impossible sur cet appareil', 'error');
            setEvent("Copie impossible sur cet appareil.", "error");
        }
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        // Submit on Enter in step 1
        if (!document.getElementById('step1').classList.contains('hidden') && e.key === 'Enter') {
            e.preventDefault();
            requestOTP();
        }
        
        // Submit on Enter in step 2
        if (!document.getElementById('step2').classList.contains('hidden') && e.key === 'Enter') {
            e.preventDefault();
            verifyOTP();
        }
    });

    // Prevent form submission on Enter in inputs
    document.querySelectorAll('input').forEach(input => {
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
            }
        });
    });
</script>
{% endblock %}
